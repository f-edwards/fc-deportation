---
title: "FC-Deportation EDA"
author: "Frank and Matt"
date: "January 11, 2018"
output: pdf_document
---

```{r packages, echo=FALSE, message=FALSE, warnings=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
library(tidyverse)
library(maps)
```

```{r setup_read, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
dat<-read_csv("./data/merged_data.csv")
dat<-dat%>%filter(.imp==0)
#dat$.imp<-factor(dat$levels = c(5, 4, 3, 2, 1, 0))

nat_dat<-dat%>%
  ungroup()%>%
  filter(reported_afcars==TRUE)%>%
  select(year, HISORGIN, child_pop, adult_pop, 
         entries_first, entries_first_nonab,
         cl, cl_not_abuse, reun_exit,
         report_source_community, report_source_law_enf,
         report_source_other)%>%
  group_by(year, HISORGIN)%>%
  mutate_at(vars(child_pop:report_source_other), as.integer, na.rm=TRUE)%>%
  summarise_at(vars(child_pop:report_source_other), sum, na.rm=TRUE)
#### summ all afcars/pop/ncands  
state_dat<-dat%>%
  ungroup()%>%
  select(year, stname, HISORGIN, child_pop, adult_pop, 
         entries_first, entries_first_nonab,
         cl, cl_not_abuse, reun_exit,
         report_source_community, report_source_law_enf,
         report_source_other)%>%
  group_by(year, HISORGIN, stname)%>%
  mutate_at(vars(child_pop:report_source_other), as.integer)%>%
  summarise_at(vars(child_pop:report_source_other), sum, na.rm=TRUE)
### join with pct of counties in scomm, 287g
state_dat<-state_dat%>%
  left_join(dat%>%
              select(year, stname, FIPS, c287active, scomm_yr_round)%>%
              group_by(FIPS, year)%>%
              distinct()%>%
              mutate(scomm_active = scomm_yr_round<=year)%>%
              group_by(stname, year)%>%
              summarise(c287active_counties = sum(as.logical(c287active), na.rm=TRUE)/n(),
                        scomm_active_counties = sum(scomm_active, na.rm=TRUE)/n()))

cnty_dat<-dat%>%
  filter(!(is.na(child_pop)))%>%
  mutate(c287active = ifelse(is.na(c287active), FALSE, c287active),
         scomm_active = scomm_yr_round <= year)

c287_nat<-cnty_dat%>%
  group_by(year, HISORGIN, c287active)%>%
  select(year, HISORGIN, child_pop, adult_pop, 
         entries_first, entries_first_nonab,
         cl, cl_not_abuse, reun_exit,
         report_source_community, report_source_law_enf,
         report_source_other)%>%
  mutate_at(vars(child_pop:report_source_other), as.integer, na.rm=TRUE)%>%
  summarise_at(vars(child_pop:report_source_other), sum, na.rm=TRUE)

c287_nat_everapplied<-cnty_dat%>%
  group_by(year, HISORGIN, c287_ever_applied)%>%
  select(year, HISORGIN, child_pop, adult_pop, 
         entries_first, entries_first_nonab,
         cl, cl_not_abuse, reun_exit,
         report_source_community, report_source_law_enf,
         report_source_other)%>%
  mutate_at(vars(child_pop:report_source_other), as.integer, na.rm=TRUE)%>%
  summarise_at(vars(child_pop:report_source_other), sum, na.rm=TRUE)

scomm_nat<-cnty_dat%>%
  group_by(year, HISORGIN, scomm_active)%>%
  filter(!(is.na(scomm_active)))%>% # those counties that were recoded prior to program?
  select(year, HISORGIN, child_pop, adult_pop, 
         entries_first, entries_first_nonab,
         cl, cl_not_abuse, reun_exit,
         report_source_community, report_source_law_enf,
         report_source_other)%>%
  mutate_at(vars(child_pop:report_source_other), as.integer, na.rm=TRUE)%>%
  summarise_at(vars(child_pop:report_source_other), sum, na.rm=TRUE)
```


# WITH IMPUTED DATA (m=1)

With data imputed from individual-level AFCARS. SUMMARISE MISSINGNESS ON VARIABLES. Will run MI with m=5 soon, computationally intensive to do so now.

# DATA NOTE

All entries described here are FIRST foster care entries.

All entries described here at entries NOT due to 

  - PHYABUSE
  - SEXABUSE 
  - AAPARENT
  - DAPARENT
  - AACHILD
  - DACHILD
  - CHILDIS
  - PRTSDIED
  
I code these removal reasons (arbitrarily) as "abuse", and exclude these cases from analsis of entries

These entries DO include those due to 

  - CHBEHPRB
  - PRTSJAIL
  - NOCOPE
  - ABANDNMENT
  - RELINQSH
  - HOUSING
  - NEGLECT
  
For those cases with missing data on removal reason, I construct an imputation model for the variable "abuse" at the child-level. These imputed data are described in this document.

## EDA AND VISUALS

### Entry rates and caseloads

There's a clear downward trend in entry rates for Latino kids from '05 to '15 that looks similar to the rate for other kids. In the state plot (note the sqrt scale on the y axis for the state plots to make them more interpretable), there's not a clear temporal trend across states, though some jumping around in select states. Note that there looks like a slight downward trend in those states with high Latino entry rates.

```{r natl descriptives}

### descriptive to figure out CA - imputation 4 is off...
# 
# ggplot(cnty_dat%>%
#          filter(HISORGIN=="hispanic",
#                 stname=="CA",
#                 .imp==5),
#        aes(x=year, y=sqrt(cl/child_pop*1000)))+
#   geom_line()+
#   facet_wrap(~FIPS)
############ caseloads
ggplot(nat_dat,
       aes(x=year, y=cl/child_pop*1000, col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()

ggplot(state_dat,
       aes(x=year, y=cl/child_pop*1000, col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()+
  facet_wrap(~stname)
#########first entries
ggplot(nat_dat,
       aes(x=year, y=entries_first/child_pop*1000, col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()

ggplot(state_dat,
       aes(x=year, y=entries_first/child_pop*1000), col=HISORGIN)+
  geom_line()+
  scale_y_sqrt()+
  facet_wrap(~stname)
###########non-abuse first entries
ggplot(nat_dat,
       aes(x=year, y=entries_first_nonab/child_pop*1000, col=HISORGIN))+
  geom_line()

ggplot(state_dat,
       aes(x=year, y=(entries_first_nonab/child_pop*1000), col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()+
  facet_wrap(~stname)
####################reun exits
ggplot(nat_dat,
       aes(x=year, y=reun_exit/cl, col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()

ggplot(state_dat,
       aes(x=year, y=(reun_exit/cl), col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()+
  facet_wrap(~stname)
#####################law enf reports
ggplot(nat_dat,
       aes(x=year, y=report_source_law_enf/child_pop*1000, col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()

ggplot(state_dat,
       aes(x=year, y=(report_source_law_enf/child_pop*1000), col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()+
  facet_wrap(~stname)
##################comm reports
ggplot(nat_dat,
       aes(x=year, y=report_source_community/child_pop*1000, col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()


ggplot(state_dat,
       aes(x=year, y=(report_source_community/child_pop*1000), col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()+
  facet_wrap(~stname)
############# total reports
ggplot(nat_dat,
       aes(x=year, y=(report_source_law_enf + 
                             report_source_community +
                             report_source_other)/ child_pop*1000,
       col=HISORGIN))+
  scale_y_sqrt()+
  geom_line()

ggplot(state_dat,
       aes(x=year, y=(report_source_law_enf + 
                             report_source_community +
                             report_source_other )/child_pop*1000,
       col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()+
   facet_wrap(~stname)



```


### baseline 287g plots

Active and inactive counties do appear very different in intercepts, but trends look similar. When restricted to incapacitation foster care entries, we see an uptick in entries for both Latino and other kids in 287(g) counties, and a clear downward trend in others. Open question about whether that's just an uptick in law enforcement activity in general in these places?


# 287g ever applied

```{r 287g_applied}
ggplot(c287_nat_everapplied, 
            aes(x=year, 
                y=cl / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287_ever_applied))+
  geom_line()+
  xlab("Year")

ggplot(c287_nat_everapplied, 
            aes(x=year, 
                y=entries_first_nonab / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287_ever_applied))+
  geom_line()+
  xlab("Year")


ggplot(c287_nat_everapplied, 
            aes(x=year, 
                y=reun_exit / cl, 
                col=HISORGIN, 
                linetype=c287_ever_applied))+
  geom_line()+
  xlab("Year")


ggplot(c287_nat_everapplied, 
            aes(x=year, 
                y=report_source_community / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287_ever_applied))+
  geom_line()+
  xlab("Year")

ggplot(c287_nat_everapplied, 
            aes(x=year, 
                y=report_source_law_enf / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287_ever_applied))+
  geom_line()+
  xlab("Year")

ggplot(c287_nat_everapplied, 
            aes(x=year, 
                y=(report_source_community + report_source_law_enf + report_source_other) / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287_ever_applied))+
  geom_line()+
  xlab("Year")



```

# 287g active

```{r 287g_active}
ggplot(c287_nat, 
            aes(x=year, 
                y=cl / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287active))+
  geom_line()+
  xlab("Year")

ggplot(c287_nat, 
            aes(x=year, 
                y=entries_first_nonab / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287active))+
  geom_line()+
  xlab("Year")


ggplot(c287_nat, 
            aes(x=year, 
                y=reun_exit / cl, 
                col=HISORGIN, 
                linetype=c287active))+
  geom_line()+
  xlab("Year")


ggplot(c287_nat, 
            aes(x=year, 
                y=report_source_community / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287active))+
  geom_line()+
  xlab("Year")

ggplot(c287_nat, 
            aes(x=year, 
                y=report_source_law_enf / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287active))+
  geom_line()+
  xlab("Year")

ggplot(c287_nat, 
            aes(x=year, 
                y=(report_source_community + report_source_law_enf + report_source_other) / child_pop * 1000, 
                col=HISORGIN, 
                linetype=c287active))+
  geom_line()+
  xlab("Year")

```


# 287g active

```{r scomm_active}
ggplot(scomm_nat, 
            aes(x=year, 
                y=cl / child_pop * 1000, 
                col=HISORGIN, 
                linetype=scomm_active))+
  geom_line()+
  xlab("Year")

ggplot(scomm_nat, 
            aes(x=year, 
                y=entries_first_nonab / child_pop * 1000, 
                col=HISORGIN, 
                linetype=scomm_active))+
  geom_line()+
  xlab("Year")


ggplot(scomm_nat, 
            aes(x=year, 
                y=reun_exit / cl, 
                col=HISORGIN, 
                linetype=scomm_active))+
  geom_line()+
  xlab("Year")


ggplot(scomm_nat, 
            aes(x=year, 
                y=report_source_community / child_pop * 1000, 
                col=HISORGIN, 
                linetype=scomm_active))+
  geom_line()+
  xlab("Year")

ggplot(scomm_nat, 
            aes(x=year, 
                y=report_source_law_enf / child_pop * 1000, 
                col=HISORGIN, 
                linetype=scomm_active))+
  geom_line()+
  xlab("Year")

ggplot(scomm_nat, 
            aes(x=year, 
                y=(report_source_community + report_source_law_enf + report_source_other) / child_pop * 1000, 
                col=HISORGIN, 
                linetype=scomm_active))+
  geom_line()+
  xlab("Year")



```

### event plots

Here are some event plots, the boxplot is the distribution of all counties with an ever-active program pre and post implementation, then a national aggregation, then a by county time series plot. Still surprising that there isn't a clear trend, but Amuedo-Dorantes and Arenas-Arroyo found that Secure Communities was carrying the load in their models, may be the same case here. I'll move the analysis in that direction next.

```{r 287g_event}

event_287<-cnty_dat%>%
  filter(!is.na(c287deny))%>%
  mutate(c287event_year = year - as.numeric(c287start_yr))%>%
  filter(!(is.na(c287event_year)))


event_scomm<-cnty_dat%>%
         mutate(scomm_event_year = year - scomm_yr_round)%>%
  filter(!(is.na(scomm_event_year)))

ggplot(event_287,
       aes(x=factor(c287event_year),
           y=entries_first_nonab/child_pop*1000,
           col=HISORGIN))+
  geom_boxplot()+
  scale_y_sqrt()

ggplot(event_scomm%>%
         group_by(scomm_event_year, HISORGIN)%>%
         summarise(entries_first_nonab = mean(sum(entries_first_nonab / child_pop, na.rm=TRUE))), #### rewrite for a mean lineplot with upper/lower bounds
       aes(x=scomm_event_year,
           y=entries_first_nonab,
           col=HISORGIN))+
  geom_line()+
  scale_y_sqrt()

# ggplot(entries_287_event,
#        aes(x=factor(event_year), y=entry_rate, col=HISORGIN))+
#   geom_boxplot()+
#   ggtitle("Ditribution of entry rates centered on 287g active")
# 
# c287_nat_event<-entries_287_event%>%
#   group_by(event_year, HISORGIN)%>%
#   summarise(entry_rate = 1000 * (sum(entries) / sum(child_pop)),
#             entries = sum(entries),
#             cases=n())
# 
# ggplot(c287_nat_event, 
#             aes(x=event_year, y=entry_rate, col=HISORGIN))+
#   geom_line()+
#   geom_vline(xintercept = 0)+
#   xlab("Year, centered on 287g active")+
#   ylab("Latino foster care entries per 1,000 children")
# 
# ggplot(entries_287_event,
#        aes(x=event_year, y=entry_rate, col=HISORGIN))+
#     geom_vline(xintercept = 0)+
#   geom_line()+
#   facet_wrap(~countyname)


```

##Secure communities

```{r s_comm_setup}
# 
# scomm_dat<-dat%>%
#   left_join(scomm%>%
#               select(-stname))%>%
#   mutate(scomm_event_time=year - Scomm_yr)%>%
#   select(-Scomm_mo, - Scomm_yr)
# 
# cnty_scomm_event<-scomm%>%
#   left_join(left_join(scomm, pop)%>%
#   group_by(FIPS, HISORGIN, year)%>%
#   summarise(child_pop=sum(child_pop)))%>%
#   left_join(dat%>%
#               group_by(FIPS, year, HISORGIN)%>%
#               summarise(entries=sum(entries)))%>%
#   mutate(entries=ifelse(is.na(entries), 0, entries),
#          entry_rate=entries/child_pop * 1000)%>%
#   mutate(event_year=year - Scomm_yr)%>%
#   filter(child_pop>10)
# 
# natl_scomm_event<-cnty_scomm_event%>%
#   group_by(event_year, HISORGIN)%>%
#   summarise(entry_rate = sum(entries)/sum(child_pop))%>%
#   filter(event_year>-5, event_year<5, !(is.na(event_year)))
# 
# ggplot(natl_scomm_event,
#        aes(x=event_year, 
#            y=entry_rate,
#            col=HISORGIN))+
#   geom_line()+
#   geom_vline(xintercept=0)+
#   ggsave("s_comm_natl.png")
# 
# ggplot(cnty_scomm_event%>%
#            filter(event_year>-5, event_year<5, !(is.na(event_year))),
#        aes(x=factor(event_year), y=entry_rate, col=HISORGIN))+
#   geom_boxplot()+
#   coord_cartesian(ylim=c(0, 10))+
#   ggtitle("Ditribution of entry rates centered on s-comm active")+
#   ggsave("s_comm_event_box.png")

```

```{r basic_models}

# cnty_scomm_event<-cnty_scomm_event%>%
#   mutate(scomm_active = year >= Scomm_yr)
# 
# library(MASS)
# 
# ### for total entries
# tot_ols_0<-lm(entry_rate ~ scomm_active * (HISORGIN == "hispanic") + 
#                   year + I(year^2),
#                 data=cnty_scomm_event)
# 
# tot_count_0<-glm.nb(entries ~ scomm_active * (HISORGIN == "hispanic") + 
#                   year + I(year^2) + offset(log(child_pop)),
#                 data=cnty_scomm_event)
# 
# ### observed v fitted - negbin
# t<-predict(tot_count_0)
# plot(cnty_scomm_event$entries, exp(t))
# abline(0,1)
# 
# ### observed v fitted - ols
# s<-predict(tot_ols_0) * cnty_scomm_event 
# plot(cnty_scomm_event$entry_rate * cnty_scomm_event$child_pop, s^2 * cnty_scomm_event$child_pop)
# abline(0,1)
# 
# tot_ols_fe<-lm(entry_rate ~ scomm_active * (HISORGIN == "hispanic") + 
#                   year + I(year^2),
#                 data=cnty_scomm_event)
# 
# tot_count_fe<-glm.nb(entries ~ scomm_active * (HISORGIN == "hispanic") + 
#                   year + I(year^2) + offset(log(child_pop)),
#                 data=cnty_scomm_event)
# 
# 


```


## Hypotheses

Just notes to self here

1. Deportation -> more total entries
  + Deportation -> more first entries
  + Deportation -> more total entries, incapacitation cause
2. Deportation -> higher caseloads
  + Deportation -> fewer reunification exits
3. Deportation -> lower community reporting

## Next steps

Contact, community reporting, exits, scomm

who are we missing? what happens to the kids? kin care? custodial transfer? 
undercoverage of kin care in census correlated with census participation - 

family complexity in census for 

to do 

filter out maltreatment cases
set up similar visuals for s-comm
pull in ncands data

MATT WILL do 
complex families stuff

Irene Vega - has interviewed ice agents, what happens to kids

aggressive counties: charlotte NC, post 2006-09 Alabama, GA, NC, SC, AZ, most aggressive places

taskforce type agreement is most aggressive - jail model least aggressive: not cleanly identified policies, proxies for increased enforcement

check on ever active and denied - 

child poverty - free/reduced lunch - what measures wouldn't be affected by undercounts - free-reduced lunch receipt is easy, no verification - NCES common core data for free-reduced districts -> counties

