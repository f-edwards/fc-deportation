---
title: "Family complexity-287g Visuals"
author: "FE"
date: "May 23, 2018"
output: html_document
---

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(haven)
```

```{r setup, echo=FALSE, message=FALSE, cache=TRUE, warning=FALSE, cache.lazy = FALSE}
library(tidyverse)
library(haven)

setwd("U:/fc-deportation")

load("models.RData")
```

#Family complexity models - PUMA population data

Below, I present model predictions from a series of models of family complexity outcomes as a function of 287g participation. Outcomes include:

- ckhhsize
- ckhhfams
- cpgkid         
- cpklivesmom    
- cpknolivespar  
- cpklivessinmom
- cpklivessinpar 
- cpknparhead    
- cpknfamhead    
- cpmixgen   

I describe the model specification at the beginning of each section. Outcome variables are labeled on the y axis of all plots. 

Counties that never implemented 287g have the year-to-287g variable set to a constant 0, and are included in the estimation of the 287g0yrs parameter

## State-year fixed effect models with state trends

These models estimate the effect of 287g on all family complexity outcomes with state and year fixed effects and within-state trends. All PUMA counties are included in these models, regardless of 287g participation. 

The models take the form:

$$\textrm{E}(\log(outcome)) \sim \beta_0 + \beta_1\textrm{Pre287g3+yrs} + \beta_1\textrm{Pre287g1-2yrs} + \beta_1\textrm{287g0yrs} + \beta_1\textrm{Post287g1-2yrs} + \beta_1\textrm{Post287g3-4yrs} + \beta_1\textrm{Post287g5+yrs}+ \alpha_{1...t}Year + \gamma_{1...s}State + Year \cdot \delta_{1...s}State + \varepsilon $$

Alpha is a vector of national year fixed effects, gamma is a vector of state fixed effects, and delta is a vector of linear state trends. 


```{r puma_st, echo=FALSE, message=FALSE, warning=FALSE}

######################################################
#### puma_models_1 by relative 287g implementation time
plot_out<-list()

for(i in 1:length(puma_models_st)){
  var<-puma_outcomes[i]
  year<-2008
  race<-unique(puma_long$race)
  fips<-4013
  state<-"4"
  tf<-FALSE ### for all 7 dummies
  
  newdat<-data.frame(expand.grid(year, race, state, fips,
                                 tf, tf, tf, tf, tf, tf, tf))
  names(newdat)<-c("year", "race", "state", "fips",
                   "c287_everactive", "c287time_minus34",
                   "c287time_minus12", "c287time_0", 
                   "c287time_plus12", "c287time_plus34", 
                   "c287time_plus56")
  
  time_index<-which(names(newdat)%in%c("c287time_minus34", "c287time_plus56"))
  #### create scenario at each time var (6) for each group
  newdat$c287_everactive<-TRUE
  newdat_template<-newdat
  for(j in time_index[1]:time_index[2]){
    newdat_temp<-newdat_template
    newdat_temp[, time_index[1]:time_index[2]]<-FALSE
    newdat_temp[, j]<-TRUE
    newdat<-rbind(newdat, newdat_temp)
  }
  
  newdat<-newdat[-c(1:3),]
  
  #### predict for each time group, for never implement
  
  predTRUE<-exp(predict(puma_models_st[[i]], newdat))
  newdat_false<-newdat_template%>%
    mutate(c287_everactive=FALSE,
           c287time_0 = TRUE)
  predFALSE<-exp(predict(puma_models_st[[i]], newdat_false))
  predFALSE<-rep(predFALSE, 6)###### CHECK ON THISS!!!!!!!
  predDIFF<-predTRUE-predFALSE
  
  newdatDIFF<-newdat
  newdatDIFF$fit<-predDIFF
  newdatDIFF$time<-rep(c(-4, -2, 0, 2, 4, 6), each=3)
  
  plot_out[[i]]<-ggplot(newdatDIFF,
         aes(x=time, y = fit))+
    geom_point()+
    geom_hline(yintercept=0, lty=2)+
    geom_vline(xintercept=0, lty=2)+
    #geom_errorbar()+
    facet_wrap(~race)+
    ylab(var)+
    ggtitle("all puma counties, state + year FEs and slopes")
  
}

plot_out[[1]]
plot_out[[2]]
plot_out[[3]]
plot_out[[4]]
plot_out[[5]]
plot_out[[6]]
plot_out[[7]]
plot_out[[8]]
plot_out[[9]]
plot_out[[10]]

```

## County-year fixed effect models

These models estimate the effect of 287g on all family complexity outcomes with county and year fixed effects. They do not include within-county trends. All PUMA counties are included in these models, regardless of 287g participation. 

The models take the form:

$$\textrm{E}(\log(outcome)) \sim \beta_0 + \beta_1\textrm{Pre287g3+yrs} + \beta_1\textrm{Pre287g1-2yrs} + \beta_1\textrm{287g0yrs} + \beta_1\textrm{Post287g1-2yrs} + \beta_1\textrm{Post287g3-4yrs} + \beta_1\textrm{Post287g5+yrs}+ \alpha_{1...t}Year + \gamma_{1...s}County + \varepsilon $$

Alpha is a vector of national year fixed effects, and gamma is a vector of county fixed effects.

```{r puma_1, echo=FALSE, message=FALSE, warning=FALSE}

######################################################
#### puma_models_1 by relative 287g implementation time
plot_out<-list()

for(i in 1:length(puma_models_1)){
  var<-puma_outcomes[i]
  year<-2008
  race<-unique(puma_long$race)
  fips<-4013
  state<-"4"
  tf<-FALSE ### for all 7 dummies
  
  newdat<-data.frame(expand.grid(year, race, state, fips,
                                 tf, tf, tf, tf, tf, tf, tf))
  names(newdat)<-c("year", "race", "state", "fips",
                   "c287_everactive", "c287time_minus34",
                   "c287time_minus12", "c287time_0", 
                   "c287time_plus12", "c287time_plus34", 
                   "c287time_plus56")
  
  time_index<-which(names(newdat)%in%c("c287time_minus34", "c287time_plus56"))
  #### create scenario at each time var (6) for each group
  newdat$c287_everactive<-TRUE
  newdat_template<-newdat
  for(j in time_index[1]:time_index[2]){
    newdat_temp<-newdat_template
    newdat_temp[, time_index[1]:time_index[2]]<-FALSE
    newdat_temp[, j]<-TRUE
    newdat<-rbind(newdat, newdat_temp)
  }
  
  newdat<-newdat[-c(1:3),]
  
  #### predict for each time group, for never implement
  
  predTRUE<-exp(predict(puma_models_1[[i]], newdat))
  newdat_false<-newdat_template%>%
    mutate(c287_everactive=FALSE,
           c287time_0 = TRUE)
  predFALSE<-exp(predict(puma_models_1[[i]], newdat_false))
  predFALSE<-rep(predFALSE, 6)
  predDIFF<-predTRUE-predFALSE
  
  newdatDIFF<-newdat
  newdatDIFF$pred<-predDIFF
  newdatDIFF$time<-rep(c(-4, -2, 0, 2, 4, 6), each=3)
  
  plot_out[[i]]<-ggplot(newdatDIFF,
         aes(x=time, y = pred))+
    geom_point()+
    geom_hline(yintercept=0, lty=2)+
    geom_vline(xintercept=0, lty=2)+
    #geom_ribbon(alpha = 0.6) + 
    facet_wrap(~race)+
    ylab(var)+
    ggtitle("all puma counties, county + year FEs")
  
}

plot_out[[1]]
plot_out[[2]]
plot_out[[3]]
plot_out[[4]]
plot_out[[5]]
plot_out[[6]]
plot_out[[7]]
plot_out[[8]]
plot_out[[9]]
plot_out[[10]]

```

## County-year fixed effect models with within-county slopes

These models estimate the effect of 287g on all family complexity outcomes with county and year fixed effects. They do include within-county trends. All PUMA counties are included in these models, regardless of 287g participation. 

The models take the form:

$$\textrm{E}(\log(outcome)) \sim \beta_0 + \beta_1\textrm{Pre287g3+yrs} + \beta_1\textrm{Pre287g1-2yrs} + \beta_1\textrm{287g0yrs} + \beta_1\textrm{Post287g1-2yrs} + \beta_1\textrm{Post287g3-4yrs} + \beta_1\textrm{Post287g5+yrs}+ \alpha_{1...t}Year + \gamma_{1...s}County + Year \cdot \delta_{1...s}State + \varepsilon $$

Alpha is a vector of national year fixed effects, and gamma is a vector of county fixed effects.

```{r puma_2, echo=FALSE, message=FALSE, warning=FALSE}

######################################################
#### puma_models_1 by relative 287g implementation time
plot_out<-list()

for(i in 1:length(puma_models_2)){
  var<-puma_outcomes[i]
  year<-2008
  race<-unique(puma_long$race)
  fips<-4013
  state<-"4"
  tf<-FALSE ### for all 7 dummies
  
  newdat<-data.frame(expand.grid(year, race, state, fips,
                                 tf, tf, tf, tf, tf, tf, tf))
  names(newdat)<-c("year", "race", "state", "fips",
                   "c287_everactive", "c287time_minus34",
                   "c287time_minus12", "c287time_0", 
                   "c287time_plus12", "c287time_plus34", 
                   "c287time_plus56")
  
  time_index<-which(names(newdat)%in%c("c287time_minus34", "c287time_plus56"))
  #### create scenario at each time var (6) for each group
  newdat$c287_everactive<-TRUE
  newdat_template<-newdat
  for(j in time_index[1]:time_index[2]){
    newdat_temp<-newdat_template
    newdat_temp[, time_index[1]:time_index[2]]<-FALSE
    newdat_temp[, j]<-TRUE
    newdat<-rbind(newdat, newdat_temp)
  }
  
  newdat<-newdat[-c(1:3),]
  
  #### predict for each time group, for never implement
  
  predTRUE<-exp(predict(puma_models_2[[i]], newdat))
  newdat_false<-newdat_template%>%
    mutate(c287_everactive=FALSE,
           c287time_0 = TRUE)
  predFALSE<-exp(predict(puma_models_2[[i]], newdat_false))
  predFALSE<-rep(predFALSE, 6)
  predDIFF<-predTRUE-predFALSE
  
  newdatDIFF<-newdat
  newdatDIFF$pred<-predDIFF
  newdatDIFF$time<-rep(c(-4, -2, 0, 2, 4, 6), each=3)
  
  plot_out[[i]]<-ggplot(newdatDIFF,
         aes(x=time, y = pred))+
    geom_point()+
    geom_hline(yintercept=0, lty=2)+
    geom_vline(xintercept=0, lty=2)+
    #geom_ribbon(alpha = 0.6) + 
    facet_wrap(~race)+
    ylab(var)+
    ggtitle("all puma counties, county + year FEs and slopes")
  
}

plot_out[[1]]
plot_out[[2]]
plot_out[[3]]
plot_out[[4]]
plot_out[[5]]
plot_out[[6]]
plot_out[[7]]
plot_out[[8]]
plot_out[[9]]
plot_out[[10]]

```

## County-year fixed effect models with within-county slopes, only counties that applied for 287g

These models estimate the effect of 287g on all family complexity outcomes with county and year fixed effects. They do include within-county trends. This includes only those PUMA counties that ever applied for 287g.

The models take the form:

$$\textrm{E}(\log(outcome)) \sim \beta_0 + \beta_1\textrm{Pre287g3+yrs} + \beta_1\textrm{Pre287g1-2yrs} + \beta_1\textrm{287g0yrs} + \beta_1\textrm{Post287g1-2yrs} + \beta_1\textrm{Post287g3-4yrs} + \beta_1\textrm{Post287g5+yrs}+ \alpha_{1...t}Year + \gamma_{1...s}County + Year \cdot \delta_{1...s}State + \varepsilon $$

Alpha is a vector of national year fixed effects, and gamma is a vector of county fixed effects.

```{r puma_3, echo=FALSE, message=FALSE, warning=FALSE}

######################################################
#### puma_models_1 by relative 287g implementation time
plot_out<-list()

for(i in 1:length(puma_models_3)){
  var<-puma_outcomes[i]
  year<-2008
  race<-unique(puma_long$race)
  fips<-4013
  state<-"4"
  tf<-FALSE ### for all 7 dummies
  
  newdat<-data.frame(expand.grid(year, race, state, fips,
                                 tf, tf, tf, tf, tf, tf, tf))
  names(newdat)<-c("year", "race", "state", "fips",
                   "c287_everactive", "c287time_minus34",
                   "c287time_minus12", "c287time_0", 
                   "c287time_plus12", "c287time_plus34", 
                   "c287time_plus56")
  
  time_index<-which(names(newdat)%in%c("c287time_minus34", "c287time_plus56"))
  #### create scenario at each time var (6) for each group
  newdat$c287_everactive<-TRUE
  newdat_template<-newdat
  for(j in time_index[1]:time_index[2]){
    newdat_temp<-newdat_template
    newdat_temp[, time_index[1]:time_index[2]]<-FALSE
    newdat_temp[, j]<-TRUE
    newdat<-rbind(newdat, newdat_temp)
  }
  
  newdat<-newdat[-c(1:3),]
  
  #### predict for each time group, for never implement
  
  predTRUE<-exp(predict(puma_models_3[[i]], newdat))
  newdat_false<-newdat_template%>%
    mutate(c287_everactive=FALSE,
           c287time_0 = TRUE)
  predFALSE<-exp(predict(puma_models_3[[i]], newdat_false))
  predFALSE<-rep(predFALSE, 6)
  predDIFF<-predTRUE-predFALSE
  
  newdatDIFF<-newdat
  newdatDIFF$pred<-predDIFF
  newdatDIFF$time<-rep(c(-4, -2, 0, 2, 4, 6), each=3)
  
  plot_out[[i]]<-ggplot(newdatDIFF,
         aes(x=time, y = pred))+
    geom_point()+
    geom_hline(yintercept=0, lty=2)+
    geom_vline(xintercept=0, lty=2)+
    #geom_ribbon(alpha = 0.6) + 
    facet_wrap(~race)+
    ylab(var)+
    ggtitle("287g application counties, county + year FEs and slopes")
  
}

plot_out[[1]]
plot_out[[2]]
plot_out[[3]]
plot_out[[4]]
plot_out[[5]]
plot_out[[6]]
plot_out[[7]]
plot_out[[8]]
plot_out[[9]]
plot_out[[10]]

```

